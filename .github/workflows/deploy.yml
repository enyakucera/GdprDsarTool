name: Deploy GdprDsarTool to Kubernetes

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  IMAGE_NAME: gdprdsar-tool
  IMAGE_TAG: latest

jobs:
  build-and-deploy:
    runs-on: self-hosted
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build Docker image
        run: |
          docker build --network=host -t ${IMAGE_NAME}:${IMAGE_TAG} .

      - name: Create secret
        run: |
          export KUBECONFIG=/etc/rancher/k3s/k3s.yaml
          kubectl create namespace production --dry-run=client -o yaml |  kubectl apply -f -
          kubectl create secret generic gdprdsar-secrets \
            --from-literal=connection-string="${{ secrets.GDPRDSAR_CONNECTION_STRING }}" \
            -n production \
            --dry-run=client -o yaml | kubectl apply -f -

      - name: Deploy to Kubernetes
        run: |
          export KUBECONFIG=/etc/rancher/k3s/k3s.yaml
          kubectl apply --server-side --force-conflicts -f k8s/

      - name: Restart deployment
        run: |
          export KUBECONFIG=/etc/rancher/k3s/k3s.yaml
          kubectl rollout restart deployment/gdprdsar-tool -n production

      - name: Wait for deployment
        id: wait_deployment
        continue-on-error: true
        run: |
          export KUBECONFIG=/etc/rancher/k3s/k3s.yaml
          kubectl rollout status deployment/gdprdsar-tool -n production --timeout=300s

      - name: Debug deployment failure
        if: steps.wait_deployment.outcome == 'failure'
        run: |
          export KUBECONFIG=/etc/rancher/k3s/k3s.yaml
          echo "==================================="
          echo "DEPLOYMENT FAILED - DEBUGGING"
          echo "==================================="
          echo ""

          echo "=== Pod Status ==="
          kubectl get pods -n production -l app=gdprdsar-tool -o wide
          echo ""

          echo "=== Recent Events ==="
          kubectl get events -n production --sort-by='.lastTimestamp' | tail -30
          echo ""

          POD_NAME=$(kubectl get pods -n production -l app=gdprdsar-tool -o jsonpath='{.items[0].metadata.name}' 2>/dev/null || echo "")

          if [ -n "$POD_NAME" ]; then
            echo "=== Pod Details: $POD_NAME ==="
            kubectl describe pod "$POD_NAME" -n production
            echo ""

            echo "=== Init Container (Migration) Logs ==="
            kubectl logs "$POD_NAME" -c migration -n production --tail=100 || echo "No migration logs"
            echo ""

            echo "=== Application Logs ==="
            kubectl logs "$POD_NAME" -c web -n production --tail=100 || echo "No app logs"
            echo ""
          fi

          echo "=== Deployment Description ==="
          kubectl describe deployment/gdprdsar-tool -n production

          exit 1

      - name: Verify deployment
        run: |
          export KUBECONFIG=/etc/rancher/k3s/k3s.yaml
          echo "=== Pods ==="
          kubectl get pods -n production -l app=gdprdsar-tool
          echo ""
          echo "=== Service ==="
          kubectl get svc -n production gdprdsar-tool
          echo ""
          echo "=== Ingress ==="
          kubectl get ingress -n production gdprdsar-tool-ingress
          echo ""
          echo "=== Certificate ==="
          kubectl get certificate -n production gdprdsar-tool-tls