name: Deploy GdprDsarTool to Kubernetes

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  IMAGE_NAME: gdprdsar-tool
  IMAGE_TAG: latest

jobs:
  build-and-deploy:
    runs-on: self-hosted
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build Docker image
        run: |
          docker build -t ${IMAGE_NAME}:${IMAGE_TAG} .

      - name: Create namespace and secret
        run: |
          export KUBECONFIG=/etc/rancher/k3s/k3s.yaml
          kubectl create namespace production --dry-run=client -o yaml | kubectl apply -f -
          kubectl create secret generic gdprdsar-secrets \
            --from-literal=connection-string="${{ secrets.GDPRDSAR_CONNECTION_STRING }}" \
            -n production \
            --dry-run=client -o yaml | kubectl apply -f -

      - name: Deploy to Kubernetes
        run: |
          export KUBECONFIG=/etc/rancher/k3s/k3s.yaml
          kubectl apply --server-side --force-conflicts -f k8s/

      - name: Restart deployment
        run: |
          export KUBECONFIG=/etc/rancher/k3s/k3s.yaml
          kubectl rollout restart deployment/gdprdsar-tool -n production

      - name: Wait for deployment
        run: |
          export KUBECONFIG=/etc/rancher/k3s/k3s.yaml
          kubectl rollout status deployment/gdprdsar-tool -n production --timeout=300s

      - name: Verify deployment
        run: |
          export KUBECONFIG=/etc/rancher/k3s/k3s.yaml
          echo "=== Pods ==="
          kubectl get pods -n production -l app=gdprdsar-tool
          echo ""
          echo "=== Service ==="
          kubectl get svc -n production gdprdsar-tool
          echo ""
          echo "=== Ingress ==="
          kubectl get ingress -n production gdprdsar-tool-ingress
          echo ""
          echo "=== Certificate ==="
          kubectl get certificate -n production gdprdsar-tool-tls